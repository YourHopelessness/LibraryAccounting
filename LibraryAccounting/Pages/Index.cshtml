@page "{currentpage=1}/{sortby=Title}"
@model LibraryAccounting.Pages.IndexModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor;
@{ ViewData["Title"] = "Бибилотека"; }

<h1>@ViewData["Title"]</h1>
<div style="font-size:20px">
    <span class="label label-success"></span>
</div>
@if (Model.BooksList == null)
{
    <p><em>Нет ни одного элемента для показа</em></p>
}
else
{
    <div class="row">
        <div class="col-md-3">

            <!--form method="post">-->
            <table class="table">
                <tr>
                    <td>
                        <form>
                            <p>
                                <select asp-for="@Model.Search.Status" asp-items="@Model.Statuses">
                                    <option value="">All</option>
                                </select>
                                <br>
                                Title: <input type="text" asp-for="@Model.Search.SearchString" value=""/>
                                <input type="submit" value="Filter" />
                            </p>
                        </form>
                    </td>
                        @if (HttpContextAccessor.HttpContext.User.IsInRole("admin"))
                        {
                        <th>

                            <button type="submit" asp-page-handler="AddBook"
                                    class="btn btn-default">
                                Добавить книгу
                            </button>
                        </th>
                    }
                    </tr>
            </table>
            <!--form>-->
        </div>
    </div>
    <div class="row">
        <div class="col-md">
            <form method="get" name="book_list" action="">
                <h2>Книги</h2>
                <hr>
                <table class="table">
                    <thead>
                        <tr>
                            <th>
                                @Html.ActionLink(@Html.DisplayNameFor(model => model.BooksList.First().ISBN), "Index", new { sortOrder = ViewBag.IsbnSortParm })
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="Title">
                                    @Html.DisplayNameFor(model => model.BooksList.First().Title)
                                </a>
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="Author">
                                    @Html.DisplayNameFor(model => model.BooksList.First().Author)
                                </a>
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="PublishedDate">
                                    @Html.DisplayNameFor(model => model.BooksList.First().PublishedDate)
                                </a>
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="PublishedBy">
                                    @Html.DisplayNameFor(model => model.BooksList.First().PublishedBy)
                                </a>
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="Status">
                                    @Html.DisplayNameFor(model => model.BooksList.First().Status)
                                </a>
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="Status">
                                    @Html.DisplayNameFor(model => model.BooksList.First().ReaderName)
                                </a>
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="Status">
                                    @Html.DisplayNameFor(model => model.BooksList.First().ReservationDate)
                                </a>
                            </th>
                            <th>
                                <a class="sort-link" asp-route-sortby="Status">
                                    @Html.DisplayNameFor(model => model.BooksList.First().ReturningDate)
                                </a>
                            </th>
                            @if (HttpContextAccessor.HttpContext.User.IsInRole("admin"))
                            {
                                <th>
                                    <a class="sort-link" asp-route-sortby="Status">
                                        @Html.DisplayNameFor(model => model.BooksList.First().ChangemakerFullName)
                                    </a>
                                </th>
                                <th>
                                    <a class="sort-link" asp-route-sortby="Status">
                                        @Html.DisplayNameFor(model => model.BooksList.First().ChangeDate)
                                    </a>
                                </th>
                                <th>
                                    <a class="sort-link" asp-route-sortby="Status">
                                        @Html.DisplayNameFor(model => model.BooksList.First().Comment)
                                    </a>
                                </th>
                            }
                            <th>
                                Действия
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var book in Model.BooksList)
                        {
                            <tr>
                                <td>@book.ISBN</td>
                                <td>@book.Title</td>
                                <td>@book.Author</td>
                                <td>@book.PublishedDate.Year</td>
                                <td>@book.PublishedBy</td>
                                <td>@book.Status</td>
                                <td>@book.ReaderName</td>
                                <td>@book.ReservationDate</td>
                                <td>@book.ReturningDate</td>
                                @if (HttpContextAccessor.HttpContext.User.IsInRole("admin"))
                                {
                                    <td>@book.ChangemakerFullName</td>
                                    <td>@book.ChangeDate</td>
                                    <td>@book.Comment</td>
                                }
                                <td>
                                
                                    @if (book.Status == "В библиотеке")
                                    {
                                        <a href="TakeBook=?id=@book.BookId">Взять книгу</a>
                                    }
                                    @if (HttpContextAccessor.HttpContext.User.IsInRole("admin"))
                                    { 
                                        <a asp-page="./EditBook" asp-route-id="@book.BookId">Редактировать</a>
                                        <a asp-page="./BookStat" asp-route-id="@book.BookId">Статистика</a>
                                        <a asp-page="./DeleteBook" asp-route-id="@book.BookId">Удалить</a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </form>
        </div>
    </div>
    <div>
        <ul class="pagination">
            <li class="page-item @(!Model.ShowFirst? "disabled":"")" title="First">
                <a class="page-link" asp-all-route-data="@(new Dictionary<string, string>{ { "currentpage", "1" },{ "sortby", Model.SortBy }})">
                    <i class="fas fa-fast-backward"></i>
                </a>
            </li>

            <li class="page-item @(!Model.ShowPrevious? "disabled":"")" title="Previous">
                <a asp-all-route-data="@(new Dictionary<string, string>{{ "currentpage", (Model.CurrentPage -1).ToString() },{ "sortby", Model.SortBy }})" class="page-link">
                    <i class="fas fa-step-backward"></i>
                </a>
            </li>
            <li class="page-item  @(!Model.ShowNext? "disabled":"")" title="Next">
                <a asp-all-route-data="@(new Dictionary<string, string>{{ "currentpage", (Model.CurrentPage + 1).ToString() },{ "sortby", Model.SortBy }})" class="page-link">
                    <i class="fas fa-step-forward"></i>
                </a>
            </li>

            <li class="page-item  @(!Model.ShowLast? "disabled":"")" title="Last">
                <a asp-all-route-data="@(new Dictionary<string, string>{{ "currentpage", Model.TotalPages.ToString() },{ "sortby", Model.SortBy }})" class="page-link">
                    <i class="fas fa-fast-forward"></i>
                </a>
            </li>
        </ul>
    </div>
}


@section scripts{
    <script>
        window.onload = function () {
            document.getElementById('TakeBook').click = function () {
                $.ajax({
                    url: '@Url.Action("TakeBook")',
                    success: function (data) {
                        $('#TakeBookView').html(data);
                    },
                    error: function (error) {
                        // handle error code

                    }
                });
            }
            var url = '@Url.Action("DisplaySearchResults", "Search")';
            $('#FilterBy').click(function() {
                    var keyWord = $('#Keyword').val();
                    $('#searchResults').load(url, { searchText: keyWord });
                })
        }
    </script>
}